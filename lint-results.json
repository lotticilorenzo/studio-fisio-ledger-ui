
> studio-fisio-ledger-ui@0.1.0 lint
> eslint --format json

[{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\admin\\appointments\\new\\page.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\admin\\appointments\\new\\page.tsx:50:5\n  48 |     const s = services.find((x) => x.id === serviceId);\n  49 |     if (!s) return;\n> 50 |     setGrossEur((s.default_price_cents / 100).toFixed(2));\n     |     ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  51 |   }, [serviceId, services]);\n  52 |\n  53 |   const selectedOperator = useMemo(","line":50,"column":5,"nodeType":null,"endLine":50,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":178,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":178,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6177,6180],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6177,6180],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport { supabase } from \"../../../../lib/supabaseClient\";\r\n\r\ntype OperatorRow = { id: string; display_name: string; commission_rate: number };\r\ntype ServiceRow = { id: string; name: string; default_price_cents: number };\r\n\r\nexport default function NewAppointmentPage() {\r\n  const [operators, setOperators] = useState<OperatorRow[]>([]);\r\n  const [services, setServices] = useState<ServiceRow[]>([]);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [ok, setOk] = useState<string | null>(null);\r\n\r\n  // form state\r\n  const [operatorId, setOperatorId] = useState(\"\");\r\n  const [serviceId, setServiceId] = useState(\"\");\r\n  const [startsAt, setStartsAt] = useState(\"\"); // datetime-local\r\n  const [status, setStatus] = useState<\"scheduled\" | \"completed\" | \"cancelled\" | \"no_show\">(\"scheduled\");\r\n  const [patientName, setPatientName] = useState(\"\");\r\n  const [grossEur, setGrossEur] = useState(\"0.00\");\r\n  const [notes, setNotes] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      setError(null);\r\n\r\n      const { data: opData, error: opErr } = await supabase\r\n        .from(\"operators\")\r\n        .select(\"id,display_name,commission_rate\")\r\n        .order(\"display_name\", { ascending: true });\r\n\r\n      const { data: srvData, error: srvErr } = await supabase\r\n        .from(\"services\")\r\n        .select(\"id,name,default_price_cents\")\r\n        .order(\"name\", { ascending: true });\r\n\r\n      if (opErr) return setError(opErr.message);\r\n      if (srvErr) return setError(srvErr.message);\r\n\r\n      setOperators((opData ?? []) as OperatorRow[]);\r\n      setServices((srvData ?? []) as ServiceRow[]);\r\n    })();\r\n  }, []);\r\n\r\n  // autopopola prezzo quando scegli servizio\r\n  useEffect(() => {\r\n    const s = services.find((x) => x.id === serviceId);\r\n    if (!s) return;\r\n    setGrossEur((s.default_price_cents / 100).toFixed(2));\r\n  }, [serviceId, services]);\r\n\r\n  const selectedOperator = useMemo(\r\n    () => operators.find((o) => o.id === operatorId) ?? null,\r\n    [operators, operatorId]\r\n  );\r\n\r\n  const commissionPreview = useMemo(() => {\r\n    const eur = Number(grossEur.replace(\",\", \".\"));\r\n    const rate = selectedOperator?.commission_rate ?? 0;\r\n    const comm = eur * rate;\r\n    return {\r\n      rate,\r\n      comm: isFinite(comm) ? comm : 0,\r\n      net: isFinite(eur - comm) ? eur - comm : 0,\r\n    };\r\n  }, [grossEur, selectedOperator]);\r\n\r\n  const submit = async () => {\r\n    setError(null);\r\n    setOk(null);\r\n\r\n    if (!operatorId) return setError(\"Seleziona un operatore.\");\r\n    if (!startsAt) return setError(\"Seleziona data e ora.\");\r\n    if (!grossEur) return setError(\"Inserisci importo.\");\r\n\r\n    const eur = Number(grossEur.replace(\",\", \".\"));\r\n    if (!isFinite(eur) || eur <= 0) return setError(\"Importo non valido.\");\r\n\r\n    const gross_amount_cents = Math.round(eur * 100);\r\n\r\n    // datetime-local -> ISO\r\n    const iso = startsAt.length === 16 ? `${startsAt}:00` : startsAt;\r\n    const starts_at = new Date(iso).toISOString();\r\n\r\n    // Usa RPC server-side per calcolo commissioni\r\n    const { error } = await supabase.rpc('admin_create_appointment', {\r\n      p_operator_id: operatorId,\r\n      p_service_id: serviceId || null,\r\n      p_patient_name: patientName.trim() || null,\r\n      p_starts_at: starts_at,\r\n      p_status: status,\r\n      p_gross_amount_cents: gross_amount_cents,\r\n      p_notes: notes || null,\r\n    });\r\n\r\n    if (error) return setError(error.message);\r\n\r\n    setOk(\"Appuntamento salvato Ô£à\");\r\n    setNotes(\"\");\r\n  };\r\n\r\n  return (\r\n    <main className=\"p-6 max-w-xl\">\r\n      <h1 className=\"text-2xl font-semibold\">Nuovo appuntamento</h1>\r\n\r\n      {error && (\r\n        <div className=\"mt-4 rounded-lg border border-red-500/40 bg-red-500/10 p-3 text-sm\">\r\n          {error}\r\n        </div>\r\n      )}\r\n      {ok && (\r\n        <div className=\"mt-4 rounded-lg border border-green-500/40 bg-green-500/10 p-3 text-sm\">\r\n          {ok}\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"mt-6 space-y-4\">\r\n        <div>\r\n          <label className=\"text-sm opacity-80\">Operatore</label>\r\n          <select\r\n            className=\"mt-1 w-full rounded-lg bg-black/30 border border-white/10 p-3\"\r\n            value={operatorId}\r\n            onChange={(e) => setOperatorId(e.target.value)}\r\n          >\r\n            <option value=\"\">Seleziona...</option>\r\n            {operators.map((o) => (\r\n              <option key={o.id} value={o.id}>\r\n                {o.display_name}\r\n              </option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"text-sm opacity-80\">Servizio</label>\r\n          <select\r\n            className=\"mt-1 w-full rounded-lg bg-black/30 border border-white/10 p-3\"\r\n            value={serviceId}\r\n            onChange={(e) => setServiceId(e.target.value)}\r\n          >\r\n            <option value=\"\">(opzionale)</option>\r\n            {services.map((s) => (\r\n              <option key={s.id} value={s.id}>\r\n                {s.name}\r\n              </option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"text-sm opacity-80\">Paziente</label>\r\n          <input\r\n            className=\"mt-1 w-full rounded-lg bg-black/30 border border-white/10 p-3\"\r\n            type=\"text\"\r\n            placeholder=\"Es. Mario Rossi\"\r\n            value={patientName}\r\n            onChange={(e) => setPatientName(e.target.value)}\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"text-sm opacity-80\">Data e ora</label>\r\n          <input\r\n            className=\"mt-1 w-full rounded-lg bg-black/30 border border-white/10 p-3\"\r\n            type=\"datetime-local\"\r\n            value={startsAt}\r\n            onChange={(e) => setStartsAt(e.target.value)}\r\n          />\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-2 gap-3\">\r\n          <div>\r\n            <label className=\"text-sm opacity-80\">Stato</label>\r\n            <select\r\n              className=\"mt-1 w-full rounded-lg bg-black/30 border border-white/10 p-3\"\r\n              value={status}\r\n              onChange={(e) => setStatus(e.target.value as any)}\r\n            >\r\n              <option value=\"scheduled\">Programmato</option>\r\n              <option value=\"completed\">Completato</option>\r\n              <option value=\"no_show\">Non presentato</option>\r\n              <option value=\"cancelled\">Disdetto</option>\r\n            </select>\r\n          </div>\r\n\r\n          <div>\r\n            <label className=\"text-sm opacity-80\">Importo (Ôé¼)</label>\r\n            <input\r\n              className=\"mt-1 w-full rounded-lg bg-black/30 border border-white/10 p-3\"\r\n              value={grossEur}\r\n              onChange={(e) => setGrossEur(e.target.value)}\r\n              inputMode=\"decimal\"\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"rounded-lg border border-white/10 p-3 text-sm\">\r\n          <div>Commissione: {(commissionPreview.rate * 100).toFixed(0)}%</div>\r\n          <div>Commissione Ôé¼: {commissionPreview.comm.toFixed(2)}</div>\r\n          <div>Netto operatore Ôé¼: {commissionPreview.net.toFixed(2)}</div>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"text-sm opacity-80\">Note (opzionale)</label>\r\n          <textarea\r\n            className=\"mt-1 w-full rounded-lg bg-black/30 border border-white/10 p-3\"\r\n            value={notes}\r\n            onChange={(e) => setNotes(e.target.value)}\r\n            rows={3}\r\n          />\r\n        </div>\r\n\r\n        <button\r\n          onClick={submit}\r\n          className=\"w-full rounded-lg bg-white text-black font-medium p-3\"\r\n        >\r\n          Salva\r\n        </button>\r\n      </div>\r\n    </main>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\admin\\appointments\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":96,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2815,2818],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2815,2818],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'logout' is defined but never used.","line":110,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":110,"endColumn":24}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":215,"column":6,"nodeType":"ArrayExpression","endLine":215,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [load, selectedMonth]","fix":{"range":[6989,7004],"text":"[load, selectedMonth]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useMemo, useState } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { supabase } from '@/lib/supabaseClient';\r\nimport { humanError } from '@/lib/humanError';\r\nimport jsPDF from 'jspdf';\r\nimport autoTable from 'jspdf-autotable';\r\n\r\ntype AppointmentRow = {\r\n  id: string;\r\n  starts_at: string;\r\n  status: string;\r\n  gross_amount_cents: number;\r\n  commission_amount_cents: number;\r\n  commission_rate: number;\r\n  operators?: { display_name: string } | null;\r\n  services?: { name: string } | null;\r\n  patients?: { full_name: string } | null;\r\n};\r\n\r\ntype OperatorSummary = {\r\n  operator_id: string;\r\n  operator_name: string;\r\n  num_appointments: number;\r\n  total_gross_cents: number;\r\n  total_commission_cents: number;\r\n  total_net_cents: number;\r\n};\r\n\r\nfunction eur(cents: number) {\r\n  return `Ôé¼${((cents ?? 0) / 100).toFixed(2)}`;\r\n}\r\n\r\nfunction statusLabel(s: string) {\r\n  if (s === 'scheduled') return 'Programmato';\r\n  if (s === 'completed') return 'Completato';\r\n  if (s === 'cancelled') return 'Disdetto';\r\n  if (s === 'no_show') return 'Non presentato';\r\n  return s;\r\n}\r\n\r\nfunction getCurrentMonth() {\r\n  const now = new Date();\r\n  return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\r\n}\r\n\r\nfunction getMonthRange(monthStr: string) {\r\n  const [year, month] = monthStr.split('-').map(Number);\r\n  const start = new Date(year, month - 1, 1);\r\n  const end = new Date(year, month, 0, 23, 59, 59, 999);\r\n  return { start, end };\r\n}\r\n\r\nexport default function AdminAppointmentsPage() {\r\n  const router = useRouter();\r\n  const [rows, setRows] = useState<AppointmentRow[]>([]);\r\n  const [summary, setSummary] = useState<OperatorSummary[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [err, setErr] = useState<string | null>(null);\r\n  const [selectedMonth, setSelectedMonth] = useState(getCurrentMonth());\r\n\r\n  async function load(month: string) {\r\n    setLoading(true);\r\n    setErr(null);\r\n\r\n    const { data: authData } = await supabase.auth.getUser();\r\n    if (!authData?.user) {\r\n      router.replace('/login');\r\n      return;\r\n    }\r\n\r\n    const { start, end } = getMonthRange(month);\r\n\r\n    // Carica appuntamenti\r\n    const { data, error } = await supabase\r\n      .from('appointments')\r\n      .select(\r\n        `\r\n        id,\r\n        starts_at,\r\n        status,\r\n        gross_amount_cents,\r\n        commission_rate,\r\n        commission_amount_cents,\r\n        operators:operator_id ( display_name ),\r\n        services:service_id ( name ),\r\n        patients:patient_id ( full_name )\r\n      `\r\n      )\r\n      .gte('starts_at', start.toISOString())\r\n      .lte('starts_at', end.toISOString())\r\n      .order('starts_at', { ascending: false });\r\n\r\n    if (error) setErr(humanError(error.message));\r\n    setRows((data as any) ?? []);\r\n\r\n    // Carica riepilogo per operatore\r\n    const { data: summaryData, error: summaryError } = await supabase.rpc('admin_month_summary', {\r\n      p_year_month: month\r\n    });\r\n\r\n    if (!summaryError && summaryData) {\r\n      setSummary(summaryData as OperatorSummary[]);\r\n    }\r\n\r\n    setLoading(false);\r\n  }\r\n\r\n  async function logout() {\r\n    await supabase.auth.signOut();\r\n    router.replace('/login');\r\n  }\r\n\r\n  function exportCSV() {\r\n    if (rows.length === 0) return;\r\n\r\n    const headers = ['Data/Ora', 'Operatore', 'Servizio', 'Paziente', 'Stato', 'Lordo', 'Commissione', 'Netto'];\r\n    const csvRows = rows.map(r => {\r\n      const netto = (r.gross_amount_cents ?? 0) - (r.commission_amount_cents ?? 0);\r\n      return [\r\n        new Date(r.starts_at).toLocaleString('it-IT'),\r\n        r.operators?.display_name ?? '-',\r\n        r.services?.name ?? '-',\r\n        r.patients?.full_name ?? '-',\r\n        statusLabel(r.status),\r\n        (r.gross_amount_cents / 100).toFixed(2),\r\n        (r.commission_amount_cents / 100).toFixed(2),\r\n        (netto / 100).toFixed(2),\r\n      ].join(';');\r\n    });\r\n\r\n    const csv = [headers.join(';'), ...csvRows].join('\\n');\r\n    const blob = new Blob(['\\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });\r\n    const url = URL.createObjectURL(blob);\r\n    const link = document.createElement('a');\r\n    link.href = url;\r\n    link.download = `appuntamenti-${selectedMonth}.csv`;\r\n    link.click();\r\n    URL.revokeObjectURL(url);\r\n  }\r\n\r\n  function exportPDF() {\r\n    if (summary.length === 0) return;\r\n\r\n    const doc = new jsPDF();\r\n    const [year, month] = selectedMonth.split('-');\r\n    const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',\r\n      'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];\r\n    const monthName = monthNames[parseInt(month) - 1];\r\n\r\n    // Header\r\n    doc.setFontSize(20);\r\n    doc.text('STUDIO FISYO', 105, 20, { align: 'center' });\r\n    doc.setFontSize(14);\r\n    doc.text(`Report Commissioni - ${monthName} ${year}`, 105, 30, { align: 'center' });\r\n    doc.setFontSize(10);\r\n    doc.text(`Generato il: ${new Date().toLocaleDateString('it-IT')}`, 105, 38, { align: 'center' });\r\n\r\n    // Summary table\r\n    const tableData = summary.map(s => [\r\n      s.operator_name,\r\n      s.num_appointments.toString(),\r\n      `Ôé¼${(s.total_gross_cents / 100).toFixed(2)}`,\r\n      `Ôé¼${(s.total_commission_cents / 100).toFixed(2)}`,\r\n      `Ôé¼${(s.total_net_cents / 100).toFixed(2)}`,\r\n    ]);\r\n\r\n    // Add totals row\r\n    const totals = summary.reduce((acc, s) => ({\r\n      appointments: acc.appointments + s.num_appointments,\r\n      gross: acc.gross + s.total_gross_cents,\r\n      commission: acc.commission + s.total_commission_cents,\r\n      net: acc.net + s.total_net_cents,\r\n    }), { appointments: 0, gross: 0, commission: 0, net: 0 });\r\n\r\n    tableData.push([\r\n      'TOTALE',\r\n      totals.appointments.toString(),\r\n      `Ôé¼${(totals.gross / 100).toFixed(2)}`,\r\n      `Ôé¼${(totals.commission / 100).toFixed(2)}`,\r\n      `Ôé¼${(totals.net / 100).toFixed(2)}`,\r\n    ]);\r\n\r\n    autoTable(doc, {\r\n      startY: 45,\r\n      head: [['Operatore', 'Appuntamenti', 'Lordo', 'Comm. Studio', 'Netto Operatore']],\r\n      body: tableData,\r\n      theme: 'striped',\r\n      headStyles: { fillColor: [41, 128, 185], textColor: 255 },\r\n      footStyles: { fillColor: [52, 73, 94], textColor: 255, fontStyle: 'bold' },\r\n      columnStyles: {\r\n        0: { cellWidth: 50 },\r\n        1: { halign: 'right', cellWidth: 30 },\r\n        2: { halign: 'right', cellWidth: 30 },\r\n        3: { halign: 'right', cellWidth: 35 },\r\n        4: { halign: 'right', cellWidth: 35 },\r\n      },\r\n      didParseCell: (data) => {\r\n        // Style the last row (totals) differently\r\n        if (data.row.index === tableData.length - 1) {\r\n          data.cell.styles.fontStyle = 'bold';\r\n          data.cell.styles.fillColor = [52, 73, 94];\r\n          data.cell.styles.textColor = 255;\r\n        }\r\n      },\r\n    });\r\n\r\n    doc.save(`report-commissioni-${selectedMonth}.pdf`);\r\n  }\r\n\r\n  useEffect(() => {\r\n    load(selectedMonth);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [selectedMonth]);\r\n\r\n  const totaleLordo = useMemo(() => rows.reduce((s, r) => s + (r.gross_amount_cents ?? 0), 0), [rows]);\r\n  const totaleComm = useMemo(() => rows.reduce((s, r) => s + (r.commission_amount_cents ?? 0), 0), [rows]);\r\n  const totaleNetto = totaleLordo - totaleComm;\r\n\r\n  return (\r\n    <main className=\"p-4 md:p-6\">\r\n      <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n        <h1 className=\"text-xl md:text-2xl font-semibold\">Appuntamenti Admin</h1>\r\n        <div className=\"flex flex-wrap gap-2\">\r\n          <button\r\n            onClick={() => router.push('/admin/appointments/new')}\r\n            className=\"btn btn-primary\"\r\n          >\r\n            + Nuovo\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Filtro Mese */}\r\n      <div className=\"mt-4 flex flex-wrap gap-2 items-center\">\r\n        <label className=\"text-sm\">Mese:</label>\r\n        <input\r\n          type=\"month\"\r\n          value={selectedMonth}\r\n          onChange={(e) => setSelectedMonth(e.target.value)}\r\n          className=\"input-field max-w-[180px]\"\r\n        />\r\n        <button onClick={exportCSV} className=\"btn btn-secondary\">\r\n          ­ƒôÑ CSV\r\n        </button>\r\n        <button onClick={exportPDF} className=\"btn btn-danger\">\r\n          ­ƒôä PDF\r\n        </button>\r\n        <button onClick={() => load(selectedMonth)} className=\"btn btn-secondary\">\r\n          Ôå╗ Ricarica\r\n        </button>\r\n      </div>\r\n\r\n      {/* Riepilogo per Operatore */}\r\n      {summary.length > 0 && (\r\n        <div className=\"mt-6\">\r\n          <h2 className=\"text-lg font-semibold mb-3\">­ƒôè Riepilogo per Operatore</h2>\r\n          <div className=\"overflow-auto rounded border\">\r\n            <table className=\"min-w-full text-sm\">\r\n              <thead className=\"border-b bg-white/10\">\r\n                <tr>\r\n                  <th className=\"text-left p-3\">Operatore</th>\r\n                  <th className=\"text-right p-3\">Appuntamenti</th>\r\n                  <th className=\"text-right p-3\">Lordo</th>\r\n                  <th className=\"text-right p-3\">Comm. Studio</th>\r\n                  <th className=\"text-right p-3\">Netto Op.</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {summary.map((s) => (\r\n                  <tr key={s.operator_id} className=\"border-b\">\r\n                    <td className=\"p-3 font-medium\">{s.operator_name}</td>\r\n                    <td className=\"p-3 text-right\">{s.num_appointments}</td>\r\n                    <td className=\"p-3 text-right\">{eur(s.total_gross_cents)}</td>\r\n                    <td className=\"p-3 text-right text-green-400\">{eur(s.total_commission_cents)}</td>\r\n                    <td className=\"p-3 text-right\">{eur(s.total_net_cents)}</td>\r\n                  </tr>\r\n                ))}\r\n                {/* Riga totali */}\r\n                <tr className=\"bg-white/5 font-semibold\">\r\n                  <td className=\"p-3\">TOTALE</td>\r\n                  <td className=\"p-3 text-right\">{summary.reduce((a, s) => a + s.num_appointments, 0)}</td>\r\n                  <td className=\"p-3 text-right\">{eur(summary.reduce((a, s) => a + s.total_gross_cents, 0))}</td>\r\n                  <td className=\"p-3 text-right text-green-400\">{eur(summary.reduce((a, s) => a + s.total_commission_cents, 0))}</td>\r\n                  <td className=\"p-3 text-right\">{eur(summary.reduce((a, s) => a + s.total_net_cents, 0))}</td>\r\n                </tr>\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Totali */}\r\n      <div className=\"mt-4 flex flex-wrap gap-3 text-sm\">\r\n        <div className=\"rounded border px-3 py-2\">\r\n          Lordo: <b>{eur(totaleLordo)}</b>\r\n        </div>\r\n        <div className=\"rounded border px-3 py-2\">\r\n          Commissioni: <b>{eur(totaleComm)}</b>\r\n        </div>\r\n        <div className=\"rounded border px-3 py-2\">\r\n          Netto: <b>{eur(totaleNetto)}</b>\r\n        </div>\r\n        <div className=\"rounded border px-3 py-2 opacity-70\">\r\n          {rows.length} appuntamenti\r\n        </div>\r\n      </div>\r\n\r\n      {loading && <p className=\"mt-6 text-center py-8\">CaricamentoÔÇª</p>}\r\n\r\n      {err && (\r\n        <div className=\"mt-6 rounded border border-red-500 p-3 text-red-200\">\r\n          Errore: {err}\r\n        </div>\r\n      )}\r\n\r\n      {!loading && !err && (\r\n        <div className=\"mt-6 table-responsive\">\r\n          <table className=\"min-w-full text-sm\">\r\n            <thead className=\"border-b bg-white/5\">\r\n              <tr>\r\n                <th className=\"text-left p-3\">Data/Ora</th>\r\n                <th className=\"text-left p-3\">Operatore</th>\r\n                <th className=\"text-left p-3\">Servizio</th>\r\n                <th className=\"text-left p-3\">Paziente</th>\r\n                <th className=\"text-left p-3\">Stato</th>\r\n                <th className=\"text-right p-3\">Lordo</th>\r\n                <th className=\"text-right p-3\">Comm.</th>\r\n                <th className=\"text-right p-3\">Netto</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {rows.map((r) => {\r\n                const netto =\r\n                  (r.gross_amount_cents ?? 0) - (r.commission_amount_cents ?? 0);\r\n                return (\r\n                  <tr key={r.id} className=\"border-b hover:bg-white/5\">\r\n                    <td className=\"p-3\">{new Date(r.starts_at).toLocaleString('it-IT')}</td>\r\n                    <td className=\"p-3\">{r.operators?.display_name ?? '-'}</td>\r\n                    <td className=\"p-3\">{r.services?.name ?? '-'}</td>\r\n                    <td className=\"p-3\">{r.patients?.full_name ?? '-'}</td>\r\n                    <td className=\"p-3\">{statusLabel(r.status)}</td>\r\n                    <td className=\"p-3 text-right\">{eur(r.gross_amount_cents ?? 0)}</td>\r\n                    <td className=\"p-3 text-right\">\r\n                      {eur(r.commission_amount_cents ?? 0)}\r\n                    </td>\r\n                    <td className=\"p-3 text-right\">{eur(netto)}</td>\r\n                  </tr>\r\n                );\r\n              })}\r\n\r\n              {rows.length === 0 && (\r\n                <tr>\r\n                  <td className=\"p-3 text-center py-8\" colSpan={8}>\r\n                    Nessun appuntamento nel mese selezionato.\r\n                  </td>\r\n                </tr>\r\n              )}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n      )}\r\n    </main>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\admin\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\admin\\operators\\page.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":159,"column":22,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[4899,5053],"text":"\r\n                    L&apos;utente deve gi├á essersi registrato (email/password). Questa funzione collega l'account esistente come operatore.\r\n                "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[4899,5053],"text":"\r\n                    L&lsquo;utente deve gi├á essersi registrato (email/password). Questa funzione collega l'account esistente come operatore.\r\n                "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[4899,5053],"text":"\r\n                    L&#39;utente deve gi├á essersi registrato (email/password). Questa funzione collega l'account esistente come operatore.\r\n                "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[4899,5053],"text":"\r\n                    L&rsquo;utente deve gi├á essersi registrato (email/password). Questa funzione collega l'account esistente come operatore.\r\n                "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":159,"column":101,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[4899,5053],"text":"\r\n                    L'utente deve gi├á essersi registrato (email/password). Questa funzione collega l&apos;account esistente come operatore.\r\n                "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[4899,5053],"text":"\r\n                    L'utente deve gi├á essersi registrato (email/password). Questa funzione collega l&lsquo;account esistente come operatore.\r\n                "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[4899,5053],"text":"\r\n                    L'utente deve gi├á essersi registrato (email/password). Questa funzione collega l&#39;account esistente come operatore.\r\n                "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[4899,5053],"text":"\r\n                    L'utente deve gi├á essersi registrato (email/password). Questa funzione collega l&rsquo;account esistente come operatore.\r\n                "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadOperators'. Either include it or remove the dependency array.","line":59,"column":8,"nodeType":"ArrayExpression","endLine":59,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [loadOperators]","fix":{"range":[1852,1854],"text":"[loadOperators]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { supabase } from '@/lib/supabaseClient';\r\nimport { humanError } from '@/lib/humanError';\r\n\r\ntype Operator = {\r\n    id: string;\r\n    display_name: string;\r\n    commission_rate: number;\r\n    user_id: string | null;\r\n};\r\n\r\nexport default function AdminOperatorsPage() {\r\n    const router = useRouter();\r\n    const [operators, setOperators] = useState<Operator[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [err, setErr] = useState<string | null>(null);\r\n    const [success, setSuccess] = useState<string | null>(null);\r\n\r\n    // Form state for new operator\r\n    const [email, setEmail] = useState('');\r\n    const [displayName, setDisplayName] = useState('');\r\n    const [commissionRate, setCommissionRate] = useState('20');\r\n    const [saving, setSaving] = useState(false);\r\n\r\n    // Edit state\r\n    const [editingId, setEditingId] = useState<string | null>(null);\r\n    const [editName, setEditName] = useState('');\r\n    const [editRate, setEditRate] = useState('');\r\n\r\n    async function loadOperators() {\r\n        setLoading(true);\r\n        setErr(null);\r\n\r\n        const { data: authData } = await supabase.auth.getUser();\r\n        if (!authData?.user) {\r\n            router.replace('/login');\r\n            return;\r\n        }\r\n\r\n        const { data, error } = await supabase\r\n            .from('operators')\r\n            .select('id, display_name, commission_rate, user_id')\r\n            .order('display_name');\r\n\r\n        if (error) {\r\n            setErr(humanError(error.message));\r\n        } else {\r\n            setOperators(data ?? []);\r\n        }\r\n        setLoading(false);\r\n    }\r\n\r\n    useEffect(() => {\r\n        loadOperators();\r\n        // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    }, []);\r\n\r\n    async function linkUser(e: React.FormEvent) {\r\n        e.preventDefault();\r\n        setSaving(true);\r\n        setErr(null);\r\n        setSuccess(null);\r\n\r\n        if (!email.trim() || !displayName.trim()) {\r\n            setErr('Email e nome sono obbligatori.');\r\n            setSaving(false);\r\n            return;\r\n        }\r\n\r\n        const rate = parseFloat(commissionRate) / 100;\r\n        if (isNaN(rate) || rate < 0 || rate > 1) {\r\n            setErr('La percentuale commissione deve essere tra 0 e 100.');\r\n            setSaving(false);\r\n            return;\r\n        }\r\n\r\n        const { error } = await supabase.rpc('admin_link_user_to_operator', {\r\n            p_user_email: email.trim(),\r\n            p_display_name: displayName.trim(),\r\n            p_commission_rate: rate,\r\n        });\r\n\r\n        if (error) {\r\n            if (error.message.includes('user_not_found')) {\r\n                setErr(`Utente con email \"${email}\" non trovato. L'utente deve prima registrarsi.`);\r\n            } else {\r\n                setErr(humanError(error.message));\r\n            }\r\n            setSaving(false);\r\n            return;\r\n        }\r\n\r\n        setSuccess(`Operatore \"${displayName}\" collegato con successo!`);\r\n        setEmail('');\r\n        setDisplayName('');\r\n        setCommissionRate('20');\r\n        setSaving(false);\r\n        loadOperators();\r\n    }\r\n\r\n    function startEdit(op: Operator) {\r\n        setEditingId(op.id);\r\n        setEditName(op.display_name);\r\n        setEditRate(((op.commission_rate ?? 0) * 100).toFixed(0));\r\n    }\r\n\r\n    function cancelEdit() {\r\n        setEditingId(null);\r\n        setEditName('');\r\n        setEditRate('');\r\n    }\r\n\r\n    async function saveEdit(opId: string) {\r\n        setErr(null);\r\n        setSuccess(null);\r\n\r\n        const rate = parseFloat(editRate) / 100;\r\n        if (isNaN(rate) || rate < 0 || rate > 1) {\r\n            setErr('La percentuale commissione deve essere tra 0 e 100.');\r\n            return;\r\n        }\r\n\r\n        if (!editName.trim()) {\r\n            setErr('Il nome ├¿ obbligatorio.');\r\n            return;\r\n        }\r\n\r\n        const { error } = await supabase\r\n            .from('operators')\r\n            .update({\r\n                display_name: editName.trim(),\r\n                commission_rate: rate,\r\n            })\r\n            .eq('id', opId);\r\n\r\n        if (error) {\r\n            setErr(humanError(error.message));\r\n            return;\r\n        }\r\n\r\n        setSuccess('Operatore aggiornato!');\r\n        setEditingId(null);\r\n        loadOperators();\r\n    }\r\n\r\n    return (\r\n        <main className=\"p-4 md:p-6 max-w-4xl mx-auto\">\r\n            <div className=\"flex items-center justify-between gap-4\">\r\n                <h1 className=\"text-xl md:text-2xl font-semibold\">Gestione Operatori</h1>\r\n            </div>\r\n\r\n            {/* Form nuovo operatore */}\r\n            <div className=\"mt-6 border rounded-lg p-4\">\r\n                <h2 className=\"text-lg font-medium mb-4\">Ô×ò Collega Nuovo Operatore</h2>\r\n                <p className=\"text-sm opacity-70 mb-4\">\r\n                    L'utente deve gi├á essersi registrato (email/password). Questa funzione collega l'account esistente come operatore.\r\n                </p>\r\n\r\n                <form onSubmit={linkUser} className=\"space-y-4\">\r\n                    <div>\r\n                        <label className=\"block text-sm mb-1\">Email utente (gi├á registrato)</label>\r\n                        <input\r\n                            type=\"email\"\r\n                            className=\"input-field\"\r\n                            value={email}\r\n                            onChange={(e) => setEmail(e.target.value)}\r\n                            placeholder=\"operatore@esempio.com\"\r\n                            required\r\n                        />\r\n                    </div>\r\n\r\n                    <div>\r\n                        <label className=\"block text-sm mb-1\">Nome visualizzato</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            className=\"input-field\"\r\n                            value={displayName}\r\n                            onChange={(e) => setDisplayName(e.target.value)}\r\n                            placeholder=\"Es. Dott. Mario Rossi\"\r\n                            required\r\n                        />\r\n                    </div>\r\n\r\n                    <div>\r\n                        <label className=\"block text-sm mb-1\">Commissione studio (%)</label>\r\n                        <input\r\n                            type=\"number\"\r\n                            min=\"0\"\r\n                            max=\"100\"\r\n                            step=\"1\"\r\n                            className=\"input-field\"\r\n                            value={commissionRate}\r\n                            onChange={(e) => setCommissionRate(e.target.value)}\r\n                            placeholder=\"20\"\r\n                        />\r\n                        <p className=\"text-xs opacity-70 mt-1\">\r\n                            Percentuale trattenuta dallo studio su ogni visita.\r\n                        </p>\r\n                    </div>\r\n\r\n                    {err && (\r\n                        <div className=\"rounded border border-red-500 bg-red-500/10 p-3 text-sm text-red-200\">\r\n                            {err}\r\n                        </div>\r\n                    )}\r\n\r\n                    {success && (\r\n                        <div className=\"rounded border border-green-500 bg-green-500/10 p-3 text-sm text-green-200\">\r\n                            {success}\r\n                        </div>\r\n                    )}\r\n\r\n                    <button\r\n                        type=\"submit\"\r\n                        disabled={saving}\r\n                        className=\"btn btn-primary w-full disabled:opacity-50\"\r\n                    >\r\n                        {saving ? 'Collego...' : 'Collega Operatore'}\r\n                    </button>\r\n                </form>\r\n            </div>\r\n\r\n            {/* Lista operatori esistenti */}\r\n            <div className=\"mt-8\">\r\n                <h2 className=\"text-lg font-medium mb-4\">­ƒæÑ Operatori Attuali</h2>\r\n\r\n                {loading && <p className=\"text-center py-4\">Caricamento...</p>}\r\n\r\n                {!loading && operators.length === 0 && (\r\n                    <p className=\"text-center py-4 opacity-70\">Nessun operatore configurato.</p>\r\n                )}\r\n\r\n                {!loading && operators.length > 0 && (\r\n                    <div className=\"table-responsive\">\r\n                        <table className=\"min-w-full text-sm\">\r\n                            <thead className=\"border-b bg-white/5\">\r\n                                <tr>\r\n                                    <th className=\"text-left p-3\">Nome</th>\r\n                                    <th className=\"text-right p-3\">Commissione</th>\r\n                                    <th className=\"text-center p-3\">Account</th>\r\n                                    <th className=\"text-center p-3\">Azioni</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody>\r\n                                {operators.map((op) => (\r\n                                    <tr key={op.id} className=\"border-b\">\r\n                                        {editingId === op.id ? (\r\n                                            <>\r\n                                                <td className=\"p-2\">\r\n                                                    <input\r\n                                                        type=\"text\"\r\n                                                        className=\"w-full border rounded px-2 py-1 bg-transparent\"\r\n                                                        value={editName}\r\n                                                        onChange={(e) => setEditName(e.target.value)}\r\n                                                    />\r\n                                                </td>\r\n                                                <td className=\"p-2\">\r\n                                                    <input\r\n                                                        type=\"number\"\r\n                                                        min=\"0\"\r\n                                                        max=\"100\"\r\n                                                        className=\"w-20 border rounded px-2 py-1 bg-transparent text-right\"\r\n                                                        value={editRate}\r\n                                                        onChange={(e) => setEditRate(e.target.value)}\r\n                                                    />\r\n                                                    <span className=\"ml-1\">%</span>\r\n                                                </td>\r\n                                                <td className=\"p-2 text-center\">\r\n                                                    {op.user_id ? (\r\n                                                        <span className=\"text-green-400\">Ô£ô</span>\r\n                                                    ) : (\r\n                                                        <span className=\"text-yellow-400\">Ô£ù</span>\r\n                                                    )}\r\n                                                </td>\r\n                                                <td className=\"p-2 text-center\">\r\n                                                    <button\r\n                                                        onClick={() => saveEdit(op.id)}\r\n                                                        className=\"px-2 py-1 rounded bg-green-600 text-white text-xs mr-1\"\r\n                                                    >\r\n                                                        Ô£ô\r\n                                                    </button>\r\n                                                    <button\r\n                                                        onClick={cancelEdit}\r\n                                                        className=\"px-2 py-1 rounded bg-gray-600 text-white text-xs\"\r\n                                                    >\r\n                                                        Ô£ù\r\n                                                    </button>\r\n                                                </td>\r\n                                            </>\r\n                                        ) : (\r\n                                            <>\r\n                                                <td className=\"p-3 font-medium\">{op.display_name}</td>\r\n                                                <td className=\"p-3 text-right\">{((op.commission_rate ?? 0) * 100).toFixed(0)}%</td>\r\n                                                <td className=\"p-3 text-center\">\r\n                                                    {op.user_id ? (\r\n                                                        <span className=\"text-green-400\">Ô£ô S├¼</span>\r\n                                                    ) : (\r\n                                                        <span className=\"text-yellow-400\">Ô£ù No</span>\r\n                                                    )}\r\n                                                </td>\r\n                                                <td className=\"p-3 text-center\">\r\n                                                    <button\r\n                                                        onClick={() => startEdit(op)}\r\n                                                        className=\"px-2 py-1 rounded border text-xs hover:bg-white/10\"\r\n                                                    >\r\n                                                        Ô£Å´©Å Modifica\r\n                                                    </button>\r\n                                                </td>\r\n                                            </>\r\n                                        )}\r\n                                    </tr>\r\n                                ))}\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </main>\r\n    );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\admin\\services\\page.tsx","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`loadServices` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\nC:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\admin\\services\\page.tsx:35:9\n  33 |\n  34 |     useEffect(() => {\n> 35 |         loadServices();\n     |         ^^^^^^^^^^^^ `loadServices` accessed before it is declared\n  36 |     }, []);\n  37 |\n  38 |     async function loadServices() {\n\nC:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\admin\\services\\page.tsx:38:5\n  36 |     }, []);\n  37 |\n> 38 |     async function loadServices() {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 39 |         setLoading(true);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^\n> 40 |         const { data, error } = await supabase\n     ÔÇª\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^\n> 50 |         setLoading(false);\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^\n> 51 |     }\n     | ^^^^^^ `loadServices` is declared here\n  52 |\n  53 |     async function handleCreate(e: React.FormEvent) {\n  54 |         e.preventDefault();","line":35,"column":9,"nodeType":null,"endLine":35,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { supabase } from '@/lib/supabaseClient';\r\nimport { humanError } from '@/lib/humanError';\r\nimport { EmptyState, emptyStates } from '@/components/EmptyState';\r\n\r\ninterface Service {\r\n    id: string;\r\n    name: string;\r\n    duration_minutes: number;\r\n    default_price_cents: number;\r\n    created_at: string;\r\n}\r\n\r\nexport default function AdminServicesPage() {\r\n    const [services, setServices] = useState<Service[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    // New service form\r\n    const [showForm, setShowForm] = useState(false);\r\n    const [newName, setNewName] = useState('');\r\n    const [newDuration, setNewDuration] = useState(60);\r\n    const [newPrice, setNewPrice] = useState('');\r\n    const [saving, setSaving] = useState(false);\r\n\r\n    // Editing\r\n    const [editingId, setEditingId] = useState<string | null>(null);\r\n    const [editName, setEditName] = useState('');\r\n    const [editDuration, setEditDuration] = useState(60);\r\n    const [editPrice, setEditPrice] = useState('');\r\n\r\n    useEffect(() => {\r\n        loadServices();\r\n    }, []);\r\n\r\n    async function loadServices() {\r\n        setLoading(true);\r\n        const { data, error } = await supabase\r\n            .from('services')\r\n            .select('*')\r\n            .order('name');\r\n\r\n        if (error) {\r\n            setError(humanError(error.message));\r\n        } else {\r\n            setServices(data || []);\r\n        }\r\n        setLoading(false);\r\n    }\r\n\r\n    async function handleCreate(e: React.FormEvent) {\r\n        e.preventDefault();\r\n        setSaving(true);\r\n        setError(null);\r\n\r\n        const priceCents = Math.round(parseFloat(newPrice) * 100);\r\n\r\n        const { error } = await supabase.from('services').insert({\r\n            name: newName.trim(),\r\n            duration_minutes: newDuration,\r\n            default_price_cents: priceCents,\r\n        });\r\n\r\n        if (error) {\r\n            setError(humanError(error.message));\r\n        } else {\r\n            setNewName('');\r\n            setNewDuration(60);\r\n            setNewPrice('');\r\n            setShowForm(false);\r\n            loadServices();\r\n        }\r\n        setSaving(false);\r\n    }\r\n\r\n    function startEdit(service: Service) {\r\n        setEditingId(service.id);\r\n        setEditName(service.name);\r\n        setEditDuration(service.duration_minutes);\r\n        setEditPrice((service.default_price_cents / 100).toFixed(2));\r\n    }\r\n\r\n    function cancelEdit() {\r\n        setEditingId(null);\r\n    }\r\n\r\n    async function saveEdit() {\r\n        if (!editingId) return;\r\n        setSaving(true);\r\n        setError(null);\r\n\r\n        const priceCents = Math.round(parseFloat(editPrice) * 100);\r\n\r\n        const { error } = await supabase\r\n            .from('services')\r\n            .update({\r\n                name: editName.trim(),\r\n                duration_minutes: editDuration,\r\n                default_price_cents: priceCents,\r\n            })\r\n            .eq('id', editingId);\r\n\r\n        if (error) {\r\n            setError(humanError(error.message));\r\n        } else {\r\n            setEditingId(null);\r\n            loadServices();\r\n        }\r\n        setSaving(false);\r\n    }\r\n\r\n    async function handleDelete(id: string) {\r\n        if (!confirm('Eliminare questo servizio?')) return;\r\n        setError(null);\r\n\r\n        const { error } = await supabase.from('services').delete().eq('id', id);\r\n\r\n        if (error) {\r\n            setError(humanError(error.message));\r\n        } else {\r\n            loadServices();\r\n        }\r\n    }\r\n\r\n    const formatPrice = (cents: number) => `Ôé¼ ${(cents / 100).toFixed(2)}`;\r\n\r\n    if (loading) {\r\n        return (\r\n            <main className=\"p-6\">\r\n                <div className=\"animate-pulse text-gray-400\">Caricamento servizi...</div>\r\n            </main>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <main className=\"p-6\">\r\n            <div className=\"flex justify-between items-center mb-6\">\r\n                <h1 className=\"text-2xl font-bold\">Gestione Servizi</h1>\r\n                <button\r\n                    onClick={() => setShowForm(!showForm)}\r\n                    className=\"px-4 py-2 rounded-lg bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-semibold hover:from-yellow-300 hover:to-orange-400 transition-all\"\r\n                >\r\n                    {showForm ? 'Ô£ò Annulla' : 'Ô×ò Nuovo Servizio'}\r\n                </button>\r\n            </div>\r\n\r\n            {error && (\r\n                <div className=\"mb-4 p-4 rounded-xl border border-red-500/30 bg-red-500/10 text-red-300\">\r\n                    ÔÜá´©Å {error}\r\n                </div>\r\n            )}\r\n\r\n            {/* New Service Form */}\r\n            {showForm && (\r\n                <form\r\n                    onSubmit={handleCreate}\r\n                    className=\"mb-6 p-6 rounded-2xl border border-yellow-500/20 bg-neutral-900/80\"\r\n                >\r\n                    <h2 className=\"text-lg font-semibold mb-4\">Nuovo Servizio</h2>\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                        <div>\r\n                            <label className=\"block text-sm text-gray-400 mb-1\">Nome</label>\r\n                            <input\r\n                                type=\"text\"\r\n                                value={newName}\r\n                                onChange={(e) => setNewName(e.target.value)}\r\n                                className=\"w-full px-4 py-2 rounded-lg bg-black/50 border border-neutral-700 text-white\"\r\n                                placeholder=\"Es: Massaggio terapeutico\"\r\n                                required\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-sm text-gray-400 mb-1\">Durata (min)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={newDuration}\r\n                                onChange={(e) => setNewDuration(parseInt(e.target.value) || 0)}\r\n                                className=\"w-full px-4 py-2 rounded-lg bg-black/50 border border-neutral-700 text-white\"\r\n                                min={5}\r\n                                step={5}\r\n                                required\r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <label className=\"block text-sm text-gray-400 mb-1\">Prezzo (Ôé¼)</label>\r\n                            <input\r\n                                type=\"number\"\r\n                                value={newPrice}\r\n                                onChange={(e) => setNewPrice(e.target.value)}\r\n                                className=\"w-full px-4 py-2 rounded-lg bg-black/50 border border-neutral-700 text-white\"\r\n                                placeholder=\"50.00\"\r\n                                step=\"0.01\"\r\n                                min=\"0\"\r\n                                required\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                    <button\r\n                        type=\"submit\"\r\n                        disabled={saving}\r\n                        className=\"mt-4 px-6 py-2 rounded-lg bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-semibold disabled:opacity-50\"\r\n                    >\r\n                        {saving ? 'Salvataggio...' : 'Crea Servizio'}\r\n                    </button>\r\n                </form>\r\n            )}\r\n\r\n            {/* Services Table */}\r\n            <div className=\"table-responsive\">\r\n                <table className=\"w-full\">\r\n                    <thead className=\"bg-neutral-800/50\">\r\n                        <tr>\r\n                            <th className=\"px-4 py-3 text-left text-sm font-medium text-gray-400\">Nome</th>\r\n                            <th className=\"px-4 py-3 text-left text-sm font-medium text-gray-400\">Durata</th>\r\n                            <th className=\"px-4 py-3 text-left text-sm font-medium text-gray-400\">Prezzo</th>\r\n                            <th className=\"px-4 py-3 text-right text-sm font-medium text-gray-400\">Azioni</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody className=\"divide-y divide-neutral-700/50\">\r\n                        {services.length === 0 ? (\r\n                            <tr>\r\n                                <td colSpan={4}>\r\n                                    <EmptyState\r\n                                        {...emptyStates.noServices}\r\n                                        action={\r\n                                            <button\r\n                                                onClick={() => setShowForm(true)}\r\n                                                className=\"btn btn-primary\"\r\n                                            >\r\n                                                + Crea Servizio\r\n                                            </button>\r\n                                        }\r\n                                    />\r\n                                </td>\r\n                            </tr>\r\n                        ) : (\r\n                            services.map((service) => (\r\n                                <tr key={service.id} className=\"hover:bg-neutral-800/30\">\r\n                                    {editingId === service.id ? (\r\n                                        <>\r\n                                            <td className=\"px-4 py-3\">\r\n                                                <input\r\n                                                    type=\"text\"\r\n                                                    value={editName}\r\n                                                    onChange={(e) => setEditName(e.target.value)}\r\n                                                    className=\"w-full px-3 py-1 rounded bg-black/50 border border-neutral-600 text-white\"\r\n                                                />\r\n                                            </td>\r\n                                            <td className=\"px-4 py-3\">\r\n                                                <input\r\n                                                    type=\"number\"\r\n                                                    value={editDuration}\r\n                                                    onChange={(e) => setEditDuration(parseInt(e.target.value) || 0)}\r\n                                                    className=\"w-20 px-3 py-1 rounded bg-black/50 border border-neutral-600 text-white\"\r\n                                                    min={5}\r\n                                                    step={5}\r\n                                                />\r\n                                                <span className=\"ml-1 text-gray-400\">min</span>\r\n                                            </td>\r\n                                            <td className=\"px-4 py-3\">\r\n                                                <span className=\"text-gray-400\">Ôé¼</span>\r\n                                                <input\r\n                                                    type=\"number\"\r\n                                                    value={editPrice}\r\n                                                    onChange={(e) => setEditPrice(e.target.value)}\r\n                                                    className=\"w-24 ml-1 px-3 py-1 rounded bg-black/50 border border-neutral-600 text-white\"\r\n                                                    step=\"0.01\"\r\n                                                    min=\"0\"\r\n                                                />\r\n                                            </td>\r\n                                            <td className=\"px-4 py-3 text-right space-x-2\">\r\n                                                <button\r\n                                                    onClick={saveEdit}\r\n                                                    disabled={saving}\r\n                                                    className=\"px-3 py-1 rounded bg-green-600 text-white text-sm hover:bg-green-500\"\r\n                                                >\r\n                                                    Ô£ô\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={cancelEdit}\r\n                                                    className=\"px-3 py-1 rounded bg-neutral-600 text-white text-sm hover:bg-neutral-500\"\r\n                                                >\r\n                                                    Ô£ò\r\n                                                </button>\r\n                                            </td>\r\n                                        </>\r\n                                    ) : (\r\n                                        <>\r\n                                            <td className=\"px-4 py-3 font-medium\">{service.name}</td>\r\n                                            <td className=\"px-4 py-3 text-gray-300\">{service.duration_minutes} min</td>\r\n                                            <td className=\"px-4 py-3 text-yellow-400 font-medium\">\r\n                                                {formatPrice(service.default_price_cents)}\r\n                                            </td>\r\n                                            <td className=\"px-4 py-3 text-right space-x-2\">\r\n                                                <button\r\n                                                    onClick={() => startEdit(service)}\r\n                                                    className=\"px-3 py-1 rounded bg-neutral-700 text-white text-sm hover:bg-neutral-600\"\r\n                                                >\r\n                                                    Ô£Å´©Å Modifica\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={() => handleDelete(service.id)}\r\n                                                    className=\"px-3 py-1 rounded bg-red-600/20 text-red-400 text-sm hover:bg-red-600/40\"\r\n                                                >\r\n                                                    ­ƒùæ´©Å\r\n                                                </button>\r\n                                            </td>\r\n                                        </>\r\n                                    )}\r\n                                </tr>\r\n                            ))\r\n                        )}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </main>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\login\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'role' is assigned a value but never used.","line":12,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport Image from \"next/image\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { supabase } from \"@/lib/supabaseClient\";\r\nimport { humanError } from \"@/lib/humanError\";\r\nimport { useAuth } from \"@/components/AuthProvider\";\r\n\r\nexport default function LoginPage() {\r\n  const router = useRouter();\r\n  const { user, role, loading: authLoading } = useAuth();\r\n  const [email, setEmail] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // If already logged in, AuthProvider handles redirect - show nothing\r\n  if (authLoading || user) {\r\n    return null;\r\n  }\r\n\r\n  const onSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    const { data: authData, error: authError } = await supabase.auth.signInWithPassword({ email, password });\r\n\r\n    if (authError) {\r\n      setLoading(false);\r\n      return setError(humanError(authError.message));\r\n    }\r\n\r\n    // Leggi il ruolo dal profilo per redirect corretto\r\n    const { data: profile, error: profileError } = await supabase\r\n      .from('profiles')\r\n      .select('role')\r\n      .eq('user_id', authData.user.id)\r\n      .single();\r\n\r\n    setLoading(false);\r\n\r\n    if (profileError || !profile?.role) {\r\n      // Default: redirect a /op se non trova profilo\r\n      router.push(\"/op/appointments\");\r\n      return;\r\n    }\r\n\r\n    const role = profile.role as string;\r\n\r\n    // Redirect basato sul ruolo\r\n    if (role === 'owner' || role === 'admin') {\r\n      router.push(\"/admin/appointments\");\r\n    } else {\r\n      router.push(\"/op/appointments\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <main className=\"min-h-screen flex items-center justify-center p-6\">\r\n      <div className=\"w-full max-w-md\">\r\n        {/* Logo / Header */}\r\n        <div className=\"text-center mb-8\">\r\n          <Image\r\n            src=\"/brand/logo.png\"\r\n            alt=\"Studio FISYO\"\r\n            width={120}\r\n            height={120}\r\n            className=\"mx-auto mb-4\"\r\n            priority\r\n          />\r\n          <p className=\"text-gray-400 mt-2\">Gestionale Appuntamenti</p>\r\n        </div>\r\n\r\n        {/* Login Card */}\r\n        <div className=\"rounded-2xl border border-yellow-500/10 bg-neutral-900/80 backdrop-blur-xl p-8 shadow-2xl\">\r\n          <h2 className=\"text-xl font-semibold mb-6 text-center\">Accedi al tuo account</h2>\r\n\r\n          <form onSubmit={onSubmit} className=\"space-y-4\">\r\n            <div>\r\n              <label className=\"block text-sm text-gray-400 mb-2\">Email</label>\r\n              <input\r\n                className=\"w-full rounded-xl bg-black/50 border border-neutral-700 px-4 py-3 text-white placeholder-gray-500 focus:border-yellow-400 focus:ring-2 focus:ring-yellow-400/20 transition-all\"\r\n                placeholder=\"nome@esempio.com\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n                type=\"email\"\r\n                required\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm text-gray-400 mb-2\">Password</label>\r\n              <input\r\n                className=\"w-full rounded-xl bg-black/50 border border-neutral-700 px-4 py-3 text-white placeholder-gray-500 focus:border-yellow-400 focus:ring-2 focus:ring-yellow-400/20 transition-all\"\r\n                placeholder=\"ÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇó\"\r\n                value={password}\r\n                onChange={(e) => setPassword(e.target.value)}\r\n                type=\"password\"\r\n                required\r\n              />\r\n            </div>\r\n            {error && (\r\n              <div className=\"rounded-xl border border-red-500/30 bg-red-500/10 p-4 text-sm text-red-300 flex items-center gap-2\">\r\n                <span>ÔÜá´©Å</span>\r\n                {error}\r\n              </div>\r\n            )}\r\n\r\n            <button\r\n              type=\"submit\"\r\n              disabled={loading}\r\n              className=\"w-full rounded-xl bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-semibold py-3 px-4 hover:from-yellow-300 hover:to-orange-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-yellow-500/20\"\r\n            >\r\n              {loading ? (\r\n                <span className=\"flex items-center justify-center gap-2\">\r\n                  <svg className=\"animate-spin h-5 w-5\" viewBox=\"0 0 24 24\">\r\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" fill=\"none\" />\r\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\r\n                  </svg>\r\n                  Accesso in corso...\r\n                </span>\r\n              ) : (\r\n                \"Accedi\"\r\n              )}\r\n            </button>\r\n          </form>\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        <p className=\"text-center text-gray-500 text-sm mt-6\">\r\n          ┬® 2026 Studio FISYO ┬À Tutti i diritti riservati\r\n        </p>\r\n      </div >\r\n    </main >\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\manifest.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\op\\appointments\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'row' is assigned a value but never used.","line":26,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useMemo, useState } from 'react';\r\nimport { useParams, useRouter } from 'next/navigation';\r\nimport { supabase } from '@/lib/supabaseClient';\r\nimport { humanError } from '@/lib/humanError';\r\n\r\ntype Service = { id: string; name: string };\r\ntype Row = {\r\n  id: string;\r\n  starts_at: string;\r\n  status: string;\r\n  service_id: string | null;\r\n  service_name: string | null;\r\n  patient_name: string | null;\r\n  gross_amount_cents: number;\r\n  notes: string | null;\r\n};\r\n\r\nexport default function OpEditAppointmentPage() {\r\n  const router = useRouter();\r\n  const params = useParams<{ id: string }>();\r\n  const id = params?.id;\r\n\r\n  const [services, setServices] = useState<Service[]>([]);\r\n  const [row, setRow] = useState<Row | null>(null);\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [saving, setSaving] = useState(false);\r\n  const [err, setErr] = useState<string | null>(null);\r\n\r\n  // form\r\n  const [startsAt, setStartsAt] = useState<string>('');\r\n  const [serviceId, setServiceId] = useState<string>('');\r\n  const [patientName, setPatientName] = useState<string>(''); // MVP: solo nome (disabled)\r\n  const [grossEuro, setGrossEuro] = useState<string>('0');\r\n  const [notes, setNotes] = useState<string>('');\r\n  const [status, setStatus] = useState<string>('scheduled');\r\n\r\n  const grossCents = useMemo(() => {\r\n    const n = Number(String(grossEuro).replace(',', '.'));\r\n    return Number.isFinite(n) ? Math.round(n * 100) : 0;\r\n  }, [grossEuro]);\r\n\r\n  function toDatetimeLocal(iso: string) {\r\n    const d = new Date(iso);\r\n    const pad = (n: number) => String(n).padStart(2, '0');\r\n    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(\r\n      d.getHours()\r\n    )}:${pad(d.getMinutes())}`;\r\n  }\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      setErr(null);\r\n\r\n      const { data: u } = await supabase.auth.getUser();\r\n      if (!u?.user) {\r\n        router.replace('/login');\r\n        return;\r\n      }\r\n\r\n      // carica servizi dell'operatore corrente\r\n      const { data: servicesData, error: servicesError } = await supabase.rpc('get_my_services_op');\r\n      if (servicesError) {\r\n        setErr(humanError(servicesError.message));\r\n        setLoading(false);\r\n        return;\r\n      }\r\n      setServices((servicesData ?? []) as Service[]);\r\n\r\n      // Carica singolo appuntamento via RPC (solo se appartiene all'operatore)\r\n      const { data, error } = await supabase.rpc('get_appointment_by_id_op', { p_id: id });\r\n      if (error) {\r\n        setErr(humanError(error.message));\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      // RPC ritorna array, prendiamo il primo (o null se non trovato)\r\n      const found = Array.isArray(data) && data.length > 0 ? data[0] : null;\r\n      if (!found) {\r\n        setErr('Appuntamento non trovato o non autorizzato.');\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      setRow(found as Row);\r\n\r\n      setStartsAt(toDatetimeLocal(found.starts_at));\r\n      setServiceId(found.service_id ?? '');\r\n      setGrossEuro(((found.gross_amount_cents ?? 0) / 100).toFixed(2));\r\n      setNotes(found.notes ?? '');\r\n      setStatus(found.status ?? 'scheduled');\r\n      setPatientName(found.patient_name ?? '');\r\n\r\n      setLoading(false);\r\n    })();\r\n  }, [id, router]);\r\n\r\n  async function save() {\r\n    if (!id) return;\r\n\r\n    setSaving(true);\r\n    setErr(null);\r\n\r\n    const { data: u } = await supabase.auth.getUser();\r\n    if (!u?.user) {\r\n      router.replace('/login');\r\n      return;\r\n    }\r\n\r\n    const { error } = await supabase.rpc('op_update_appointment', {\r\n      p_appointment_id: id,\r\n      p_starts_at: new Date(startsAt).toISOString(),\r\n      p_status: status,\r\n      p_gross_amount_cents: grossCents,\r\n      p_notes: notes || null,\r\n      p_service_id: serviceId || null,\r\n    });\r\n\r\n    if (error) {\r\n      setErr(humanError(error.message));\r\n      setSaving(false);\r\n      return;\r\n    }\r\n\r\n    router.replace('/op/appointments');\r\n  }\r\n\r\n  async function cancel() {\r\n    if (!id) return;\r\n\r\n    // Conferma prima di disdire\r\n    const conferma = window.confirm(\r\n      'Sei sicuro di voler disdire questo appuntamento?\\n\\nQuesta azione non pu├▓ essere annullata.'\r\n    );\r\n    if (!conferma) return;\r\n\r\n    setSaving(true);\r\n    setErr(null);\r\n\r\n    const { data: u } = await supabase.auth.getUser();\r\n    if (!u?.user) {\r\n      router.replace('/login');\r\n      return;\r\n    }\r\n\r\n    const { error } = await supabase.rpc('op_cancel_appointment', {\r\n      p_appointment_id: id,\r\n    });\r\n\r\n    if (error) {\r\n      setErr(humanError(error.message));\r\n      setSaving(false);\r\n      return;\r\n    }\r\n\r\n    router.replace('/op/appointments');\r\n  }\r\n\r\n  if (loading) return <main className=\"p-6\">CaricoÔÇª</main>;\r\n\r\n  return (\r\n    <main className=\"p-6 max-w-xl\">\r\n      <div className=\"flex items-center justify-between gap-3\">\r\n        <h1 className=\"text-2xl font-semibold\">Modifica appuntamento</h1>\r\n        <button className=\"border rounded px-3 py-2\" onClick={() => router.back()}>\r\n          Indietro\r\n        </button>\r\n      </div>\r\n\r\n      {err && (\r\n        <div className=\"mt-4 border border-red-500 rounded p-3 text-red-200\">\r\n          Errore: {err}\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"mt-6 space-y-4\">\r\n        <div>\r\n          <label className=\"block text-sm mb-1\">Data e ora</label>\r\n          <input\r\n            type=\"datetime-local\"\r\n            className=\"w-full border rounded px-3 py-2 bg-transparent\"\r\n            value={startsAt}\r\n            onChange={(e) => setStartsAt(e.target.value)}\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm mb-1\">Paziente</label>\r\n          <input\r\n            className=\"w-full border rounded px-3 py-2 bg-transparent\"\r\n            value={patientName}\r\n            onChange={(e) => setPatientName(e.target.value)}\r\n            disabled\r\n          />\r\n          <p className=\"text-xs opacity-70 mt-1\">(Per MVP non cambiamo il paziente qui.)</p>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm mb-1\">Servizio</label>\r\n          <select\r\n            className=\"w-full border rounded px-3 py-2 bg-transparent\"\r\n            value={serviceId}\r\n            onChange={(e) => setServiceId(e.target.value)}\r\n          >\r\n            <option value=\"\">Nessun servizio</option>\r\n            {services.map((s) => (\r\n              <option key={s.id} value={s.id}>\r\n                {s.name}\r\n              </option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm mb-1\">Stato</label>\r\n          <select\r\n            className=\"w-full border rounded px-3 py-2 bg-transparent\"\r\n            value={status}\r\n            onChange={(e) => setStatus(e.target.value)}\r\n          >\r\n            <option value=\"scheduled\">Programmato</option>\r\n            <option value=\"completed\">Completato</option>\r\n            <option value=\"no_show\">Non presentato</option>\r\n            <option value=\"cancelled\">Disdetto</option>\r\n          </select>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm mb-1\">Importo lordo (Ôé¼)</label>\r\n          <input\r\n            className=\"w-full border rounded px-3 py-2 bg-transparent\"\r\n            value={grossEuro}\r\n            onChange={(e) => setGrossEuro(e.target.value)}\r\n            inputMode=\"decimal\"\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm mb-1\">Note</label>\r\n          <textarea\r\n            className=\"w-full border rounded px-3 py-2 bg-transparent\"\r\n            value={notes}\r\n            onChange={(e) => setNotes(e.target.value)}\r\n            rows={3}\r\n          />\r\n        </div>\r\n\r\n        <button onClick={save} disabled={saving} className=\"w-full border rounded px-3 py-2\">\r\n          {saving ? 'SalvoÔÇª' : 'Salva modifiche'}\r\n        </button>\r\n\r\n        <button onClick={cancel} disabled={saving} className=\"w-full border rounded px-3 py-2\">\r\n          Disdici appuntamento\r\n        </button>\r\n      </div>\r\n    </main>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\op\\appointments\\new\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is assigned a value but never used.","line":89,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":89,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useMemo, useState } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { supabase } from '@/lib/supabaseClient';\r\nimport { humanError } from '@/lib/humanError';\r\n\r\ntype Service = { id: string; name: string };\r\n\r\nexport default function OpNewAppointmentPage() {\r\n  const router = useRouter();\r\n  const [loading, setLoading] = useState(false);\r\n  const [err, setErr] = useState<string | null>(null);\r\n\r\n  const [services, setServices] = useState<Service[]>([]);\r\n\r\n  // form\r\n  const [startsAt, setStartsAt] = useState<string>(() => {\r\n    const d = new Date(Date.now() + 60 * 60 * 1000);\r\n    const pad = (n: number) => String(n).padStart(2, '0');\r\n    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(\r\n      d.getHours()\r\n    )}:${pad(d.getMinutes())}`;\r\n  });\r\n\r\n  const [serviceId, setServiceId] = useState<string>('');\r\n  const [patientName, setPatientName] = useState<string>('');\r\n  const [grossEuro, setGrossEuro] = useState<string>('80');\r\n  const [notes, setNotes] = useState<string>('');\r\n\r\n  const grossCents = useMemo(() => {\r\n    const n = Number(String(grossEuro).replace(',', '.'));\r\n    return Number.isFinite(n) ? Math.round(n * 100) : 0;\r\n  }, [grossEuro]);\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      setErr(null);\r\n\r\n      const { data: u } = await supabase.auth.getUser();\r\n      if (!u?.user) {\r\n        router.replace('/login');\r\n        return;\r\n      }\r\n\r\n      // Carica solo i servizi dell'operatore corrente\r\n      const { data, error } = await supabase.rpc('get_my_services_op');\r\n\r\n      if (error) setErr(humanError(error.message));\r\n      else setServices((data ?? []) as Service[]);\r\n    })();\r\n  }, [router]);\r\n\r\n\r\n  async function save() {\r\n    setLoading(true);\r\n    setErr(null);\r\n\r\n    const { data: u } = await supabase.auth.getUser();\r\n    if (!u?.user) {\r\n      router.replace('/login');\r\n      return;\r\n    }\r\n\r\n    if (!patientName.trim()) {\r\n      setErr('Inserisci almeno il nome del paziente.');\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    if (!serviceId) {\r\n      setErr('Seleziona un servizio.');\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    if (grossCents <= 0) {\r\n      setErr('Inserisci un importo valido.');\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    // Validazione: data non pu├▓ essere nel passato\r\n    const appointmentDate = new Date(startsAt);\r\n    if (appointmentDate < new Date()) {\r\n      setErr('Non puoi creare un appuntamento nel passato.');\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    // Ô£à QUI: niente insert su patients dal frontend\r\n    const { data, error } = await supabase.rpc('op_create_appointment', {\r\n      p_service_id: serviceId,\r\n      p_starts_at: new Date(startsAt).toISOString(),\r\n      p_patient_full_name: patientName.trim(),\r\n      p_gross_amount_cents: grossCents,\r\n      p_notes: notes || null,\r\n    });\r\n\r\n    if (error) {\r\n      setErr(humanError(error.message));\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    // data = uuid dell'appuntamento\r\n    router.replace('/op/appointments');\r\n  }\r\n\r\n  return (\r\n    <main className=\"p-6 max-w-xl\">\r\n      <div className=\"flex items-center justify-between gap-3\">\r\n        <h1 className=\"text-2xl font-semibold\">Nuovo appuntamento</h1>\r\n        <button className=\"border rounded px-3 py-2\" onClick={() => router.back()}>\r\n          Indietro\r\n        </button>\r\n      </div>\r\n\r\n      {err && (\r\n        <div className=\"mt-4 border border-red-500 rounded p-3 text-red-200\">\r\n          Errore: {err}\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"mt-6 space-y-4\">\r\n        <div>\r\n          <label className=\"block text-sm mb-1\">Data e ora</label>\r\n          <input\r\n            type=\"datetime-local\"\r\n            className=\"w-full border rounded px-3 py-2 bg-transparent\"\r\n            value={startsAt}\r\n            onChange={(e) => setStartsAt(e.target.value)}\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm mb-1\">Servizio</label>\r\n          <select\r\n            className=\"w-full border rounded px-3 py-2 bg-transparent\"\r\n            value={serviceId}\r\n            onChange={(e) => setServiceId(e.target.value)}\r\n          >\r\n            <option value=\"\">SelezionaÔÇª</option>\r\n            {services.map((s) => (\r\n              <option key={s.id} value={s.id}>\r\n                {s.name}\r\n              </option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm mb-1\">Paziente (nome)</label>\r\n          <input\r\n            className=\"w-full border rounded px-3 py-2 bg-transparent\"\r\n            value={patientName}\r\n            onChange={(e) => setPatientName(e.target.value)}\r\n            placeholder=\"Es. Maria Rossi\"\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm mb-1\">Importo lordo (Ôé¼)</label>\r\n          <input\r\n            className=\"w-full border rounded px-3 py-2 bg-transparent\"\r\n            value={grossEuro}\r\n            onChange={(e) => setGrossEuro(e.target.value)}\r\n            inputMode=\"decimal\"\r\n            placeholder=\"80\"\r\n          />\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block text-sm mb-1\">Note (opzionale)</label>\r\n          <textarea\r\n            className=\"w-full border rounded px-3 py-2 bg-transparent\"\r\n            value={notes}\r\n            onChange={(e) => setNotes(e.target.value)}\r\n            rows={3}\r\n          />\r\n        </div>\r\n\r\n        <button\r\n          onClick={save}\r\n          disabled={loading}\r\n          className=\"w-full border rounded px-3 py-2\"\r\n        >\r\n          {loading ? 'SalvoÔÇª' : 'Salva appuntamento'}\r\n        </button>\r\n      </div>\r\n    </main>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\op\\appointments\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":83,"column":6,"nodeType":"ArrayExpression","endLine":83,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [load]","fix":{"range":[2153,2155],"text":"[load]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\op\\layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useRouter' is defined but never used.","line":5,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useRouter"},"fix":{"range":[96,107],"text":""},"desc":"Remove unused variable \"useRouter\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport React from 'react';\r\nimport Link from 'next/link';\r\nimport { usePathname, useRouter } from 'next/navigation';\r\nimport { AppHeader } from '@/components/AppHeader';\r\nimport { useAuth } from '@/components/AuthProvider';\r\n\r\nfunction OpNav() {\r\n    const pathname = usePathname();\r\n\r\n    const links = [\r\n        { href: '/op/appointments', label: 'I Miei Appuntamenti', icon: '­ƒôà' },\r\n        { href: '/op/appointments/new', label: 'Nuovo', icon: 'Ô×ò' },\r\n    ];\r\n\r\n    return (\r\n        <nav className=\"border-b border-neutral-700/50 bg-neutral-800/30 px-4 py-2\">\r\n            <div className=\"max-w-4xl mx-auto flex gap-1\">\r\n                {links.map((link) => {\r\n                    const isActive = pathname === link.href;\r\n                    return (\r\n                        <Link\r\n                            key={link.href}\r\n                            href={link.href}\r\n                            className={`px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-all ${isActive\r\n                                ? 'bg-green-500/20 text-green-400 font-medium border border-green-500/30'\r\n                                : 'text-gray-400 hover:text-white hover:bg-neutral-700/50'\r\n                                }`}\r\n                        >\r\n                            <span>{link.icon}</span>\r\n                            {link.label}\r\n                        </Link>\r\n                    );\r\n                })}\r\n            </div>\r\n        </nav>\r\n    );\r\n}\r\n\r\nexport default function OpLayout({ children }: { children: React.ReactNode }) {\r\n    const { user, loading } = useAuth();\r\n\r\n    // AuthProvider gestisce i redirect, qui solo loading check\r\n    if (loading || !user) {\r\n        return (\r\n            <main className=\"min-h-screen flex items-center justify-center\">\r\n                <div className=\"flex flex-col items-center gap-4\">\r\n                    <div className=\"animate-spin h-8 w-8 border-4 border-green-500 border-t-transparent rounded-full\"></div>\r\n                    <p className=\"text-gray-400\">Caricamento...</p>\r\n                </div>\r\n            </main>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"min-h-screen\">\r\n            <AppHeader subtitle=\"Area Operatore\" variant=\"operator\" maxWidth=\"max-w-4xl\" />\r\n            <OpNav />\r\n            <div className=\"max-w-4xl mx-auto\">\r\n                {children}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\components\\AppHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\components\\AuthProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\components\\EmptyState.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\components\\Toast.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":3,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[34,45],"text":""},"desc":"Remove unused variable \"useEffect\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect, createContext, useContext, useCallback, ReactNode } from 'react';\r\n\r\ntype ToastType = 'success' | 'error' | 'info';\r\n\r\ninterface Toast {\r\n    id: number;\r\n    message: string;\r\n    type: ToastType;\r\n}\r\n\r\ninterface ToastContextType {\r\n    showToast: (message: string, type?: ToastType) => void;\r\n    showError: (message: string) => void;\r\n    showSuccess: (message: string) => void;\r\n}\r\n\r\nconst ToastContext = createContext<ToastContextType | null>(null);\r\n\r\nlet toastId = 0;\r\n\r\nexport function ToastProvider({ children }: { children: ReactNode }) {\r\n    const [toasts, setToasts] = useState<Toast[]>([]);\r\n\r\n    const showToast = useCallback((message: string, type: ToastType = 'info') => {\r\n        const id = ++toastId;\r\n        setToasts((prev) => [...prev, { id, message, type }]);\r\n\r\n        // Auto-dismiss after 4 seconds\r\n        setTimeout(() => {\r\n            setToasts((prev) => prev.filter((t) => t.id !== id));\r\n        }, 4000);\r\n    }, []);\r\n\r\n    const showError = useCallback((message: string) => {\r\n        showToast(message, 'error');\r\n    }, [showToast]);\r\n\r\n    const showSuccess = useCallback((message: string) => {\r\n        showToast(message, 'success');\r\n    }, [showToast]);\r\n\r\n    const dismiss = (id: number) => {\r\n        setToasts((prev) => prev.filter((t) => t.id !== id));\r\n    };\r\n\r\n    return (\r\n        <ToastContext.Provider value={{ showToast, showError, showSuccess }}>\r\n            {children}\r\n\r\n            {/* Toast Container */}\r\n            <div className=\"fixed bottom-4 right-4 z-[100] flex flex-col gap-2 max-w-sm\">\r\n                {toasts.map((toast) => (\r\n                    <div\r\n                        key={toast.id}\r\n                        onClick={() => dismiss(toast.id)}\r\n                        className={`\r\n              px-4 py-3 rounded-xl shadow-lg cursor-pointer\r\n              transform transition-all duration-300 ease-out\r\n              animate-slide-in\r\n              ${toast.type === 'success'\r\n                                ? 'bg-green-600 text-white border border-green-500'\r\n                                : toast.type === 'error'\r\n                                    ? 'bg-red-600 text-white border border-red-500'\r\n                                    : 'bg-neutral-800 text-white border border-neutral-700'\r\n                            }\r\n            `}\r\n                    >\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-lg\">\r\n                                {toast.type === 'success' ? 'Ô£ô' : toast.type === 'error' ? 'ÔÜá' : 'Ôä╣'}\r\n                            </span>\r\n                            <span className=\"text-sm font-medium\">{toast.message}</span>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n            </div>\r\n\r\n            <style jsx global>{`\r\n        @keyframes slide-in {\r\n          from {\r\n            opacity: 0;\r\n            transform: translateX(100%);\r\n          }\r\n          to {\r\n            opacity: 1;\r\n            transform: translateX(0);\r\n          }\r\n        }\r\n        .animate-slide-in {\r\n          animation: slide-in 0.3s ease-out;\r\n        }\r\n      `}</style>\r\n        </ToastContext.Provider>\r\n    );\r\n}\r\n\r\nexport function useToast() {\r\n    const context = useContext(ToastContext);\r\n    if (!context) {\r\n        // Return no-op functions if used outside provider\r\n        return {\r\n            showToast: () => { },\r\n            showError: () => { },\r\n            showSuccess: () => { },\r\n        };\r\n    }\r\n    return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\lib\\humanError.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\lib\\supabaseClient.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\lotti\\studio-fisio-ledger-ui\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
